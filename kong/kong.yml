_format_version: "3.0"
_transform: true

# Kong AWS Masking MVP - Basic DB-less Configuration
# Following 02_Kong_DB-less_Setup_Guide_2025.md standards

services:
  - name: backend-api
    url: http://backend:3000
    protocol: http
    retries: 5
    connect_timeout: 30000
    write_timeout: 60000
    read_timeout: 60000
    tags:
      - backend
      - api
      
  - name: anthropic-api
    url: https://api.anthropic.com/v1/messages
    protocol: https
    host: api.anthropic.com
    port: 443
    path: /v1/messages
    retries: 3
    connect_timeout: 5000
    write_timeout: 30000
    read_timeout: 30000
    tags:
      - claude
      - external-api
    
routes:
  - name: analyze-route
    service: backend-api
    paths:
      - /analyze
    methods:
      - POST
    strip_path: false
    preserve_host: false
    tags:
      - aws-analysis
        
  - name: health-route
    service: backend-api
    paths:
      - /health
    methods:
      - GET
    strip_path: false
    tags:
      - health-check
          
  - name: aws-resource-route
    service: backend-api
    paths:
      - /aws
    methods:
      - GET
      - POST
    strip_path: false
    tags:
      - aws-resources

  - name: claude-api-route
    service: anthropic-api
    paths:
      - /analyze-claude
    methods:
      - POST
    strip_path: true
    preserve_host: false
    request_buffering: true
    response_buffering: true
    tags:
      - claude-api
      - masking-required

# AWS Masker Plugin Configuration
plugins:
  - name: aws-masker
    route: claude-api-route
    config:
      mask_ec2_instances: true
      mask_s3_buckets: true
      mask_rds_instances: true
      mask_private_ips: true
      preserve_structure: true
      log_masked_requests: true
