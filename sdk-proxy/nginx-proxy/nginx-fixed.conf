user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log notice;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Custom log format for detailed request/response logging
    log_format claude_proxy '$remote_addr - $remote_user [$time_local] '
                           '"$request" $status $body_bytes_sent '
                           '"$http_referer" "$http_user_agent" '
                           'req_time=$request_time '
                           'upstream_time=$upstream_response_time '
                           'proxy_host=$proxy_host '
                           'request_id=$custom_request_id';

    # Access log for all requests
    access_log /var/log/nginx/access.log claude_proxy;

    # Request body logging for debugging
    client_body_buffer_size 16k;
    client_max_body_size 10m;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Generate unique request ID for tracking
    map $host $custom_request_id {
        default "$pid-$msec-$remote_addr-$connection";
    }

    # DNS resolver for upstream
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    server {
        listen 80;
        server_name _;

        location / {
            # Add custom headers to identify proxy
            proxy_set_header X-Proxy-Via "nginx-claude-proxy";
            proxy_set_header X-Request-ID $custom_request_id;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Host api.anthropic.com;
            
            # CRITICAL: Set SNI for SSL handshake
            proxy_ssl_server_name on;
            proxy_ssl_name api.anthropic.com;

            # Pass through original headers
            proxy_pass_request_headers on;
            
            # SSL settings for upstream - Updated for Claude API requirements
            proxy_ssl_protocols TLSv1.2 TLSv1.3;
            proxy_ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384';
            proxy_ssl_verify off;
            proxy_ssl_session_reuse on;

            # Force IPv4 resolution
            set $backend "api.anthropic.com:443";
            proxy_pass https://$backend;

            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;

            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 8k;
            proxy_buffers 16 8k;
            proxy_busy_buffers_size 16k;

            # HTTP version
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            # Add response headers
            add_header X-Proxy-Via "nginx-claude-proxy" always;
            add_header X-Request-ID $custom_request_id always;
            add_header X-Proxy-Timestamp $msec always;

            # Log request body for debugging (be careful with sensitive data)
            access_log /var/log/nginx/claude_requests.log claude_proxy;
            
            # Enable detailed error logging
            error_log /var/log/nginx/claude_errors.log debug;
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "nginx proxy healthy\n";
            add_header Content-Type text/plain;
        }

        # Proxy status endpoint
        location /proxy-status {
            return 200 '{"status":"active","proxy":"nginx-claude-proxy","version":"1.0.0","timestamp":"$msec"}';
            add_header Content-Type application/json;
        }
    }

    # Additional server for detailed request/response logging (optional)
    server {
        listen 8080;
        server_name _;
        
        location /nginx_status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            deny all;
        }
    }
}