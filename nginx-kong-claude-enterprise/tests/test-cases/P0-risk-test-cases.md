# P0 Risk Test Cases for nginx-kong-claude-enterprise

## Architecture Overview
```
Client → Nginx (8082) → Kong (8000) → Claude API
           ↓               ↓
       Health Check    AWS Masker Plugin
                           ↓
                        Redis Store
```

## Test Suite Structure

### 1. Nginx Proxy Failure Scenarios

#### TC-NX-001: Nginx Container Crash
- **테스트 ID**: TC-NX-001
- **테스트 설명**: Nginx 컨테이너가 갑작스럽게 중단되는 시나리오 검증
- **전제 조건**: 
  - 모든 서비스가 정상 실행 중
  - 클라이언트가 활성 요청을 처리 중
- **테스트 단계**:
  1. Claude API 호출 시작 (대용량 응답 요청)
  2. 응답 스트리밍 중 `docker stop nginx-claude-proxy`
  3. 클라이언트 측 에러 응답 확인
  4. 다른 서비스(Kong, Redis) 상태 확인
- **예상 결과**:
  - 클라이언트는 connection reset 또는 502 에러 수신
  - Kong과 Redis는 계속 정상 작동
  - Docker restart policy에 의해 자동 재시작
- **엣지 케이스**:
  - 요청 처리 중 크래시 (데이터 일부만 전송된 상태)
  - 멀티 요청 동시 처리 중 크래시
- **경계 조건**:
  - 최대 버퍼 크기(8k) 도달 시점에서 크래시
  - Keep-alive 연결 유지 중 크래시

#### TC-NX-002: Nginx Worker Process 고갈
- **테스트 ID**: TC-NX-002
- **테스트 설명**: Nginx worker 프로세스가 모두 사용 중일 때의 동작 검증
- **전제 조건**:
  - `NGINX_WORKER_PROCESSES=2`
  - `NGINX_WORKER_CONNECTIONS=10`
- **테스트 단계**:
  1. 20개의 동시 연결 생성 (느린 응답 시뮬레이션)
  2. 추가 연결 시도
  3. 에러 로그 및 응답 확인
  4. 일부 연결 종료 후 재시도
- **예상 결과**:
  - 추가 연결은 거부됨 (503 Service Unavailable)
  - 기존 연결은 계속 처리됨
  - 연결 종료 시 새 연결 즉시 가능
- **엣지 케이스**:
  - Worker 프로세스 중 하나만 응답 불가 상태
  - 모든 Worker가 동시에 재시작되는 경우
- **경계 조건**:
  - 정확히 worker_connections 수만큼 연결
  - worker_connections + 1 연결 시도

#### TC-NX-003: Nginx 메모리 한계 도달
- **테스트 ID**: TC-NX-003
- **테스트 설명**: Nginx 컨테이너 메모리 제한(256MB) 도달 시 동작
- **전제 조건**:
  - Docker 메모리 제한 활성화
  - 대용량 요청/응답 페이로드 준비
- **테스트 단계**:
  1. 100MB 크기의 요청 본문 3개 동시 전송
  2. 메모리 사용량 모니터링
  3. OOM killer 동작 확인
  4. 컨테이너 재시작 후 상태 확인
- **예상 결과**:
  - 메모리 한계 도달 시 컨테이너 재시작
  - 진행 중인 요청은 실패
  - 재시작 후 정상 서비스 재개
- **엣지 케이스**:
  - 메모리 한계 근처에서 요청 처리
  - 버퍼 플러시 중 메모리 부족
- **경계 조건**:
  - 255MB 사용 중 추가 할당 요청
  - 정확히 256MB 도달 시점

#### TC-NX-004: Nginx Upstream (Kong) 연결 실패
- **테스트 ID**: TC-NX-004
- **테스트 설명**: Kong 서비스가 응답하지 않을 때 Nginx 동작
- **전제 조건**:
  - Nginx는 정상, Kong 중지
- **테스트 단계**:
  1. Kong 서비스 중지 (`docker stop kong-gateway`)
  2. Claude API 요청 전송
  3. Nginx 에러 응답 확인
  4. Kong 재시작 후 재시도
- **예상 결과**:
  - 502 Bad Gateway 응답
  - 5초 내 타임아웃 (proxy_connect_timeout)
  - Kong 재시작 후 즉시 정상화
- **엣지 케이스**:
  - Kong이 시작 중일 때 요청
  - Kong health check는 통과하나 실제 요청 실패
- **경계 조건**:
  - 정확히 5초 타임아웃
  - 4.9초에 연결 성공

### 2. Kong aws-masker Plugin Masking Failure Cases

#### TC-KM-001: JSON 파싱 실패
- **테스트 ID**: TC-KM-001
- **테스트 설명**: 잘못된 JSON 형식의 요청 처리
- **전제 조건**:
  - aws-masker 플러그인 활성화
  - Redis 정상 작동
- **테스트 단계**:
  1. 잘못된 JSON 전송: `{"content": "test", invalid}`
  2. 중첩 깊이 초과 JSON 전송 (100+ levels)
  3. 순환 참조가 있는 JSON 구조
  4. 에러 응답 확인
- **예상 결과**:
  - 400 Bad Request 응답
  - 원본 데이터는 마스킹되지 않음
  - 에러 로그에 파싱 실패 기록
- **엣지 케이스**:
  - UTF-8 인코딩 오류가 있는 JSON
  - 이스케이프 처리 오류
  - JSON 크기 제한 초과
- **경계 조건**:
  - 최대 JSON 깊이 (보통 1000)
  - 최대 문자열 길이

#### TC-KM-002: 패턴 매칭 엔진 오버플로우
- **테스트 ID**: TC-KM-002
- **테스트 설명**: 대량의 AWS 리소스가 포함된 요청 처리
- **전제 조건**:
  - 10,000개 이상의 고유 AWS 리소스 ID 준비
- **테스트 단계**:
  1. 10,000개의 EC2 인스턴스 ID가 포함된 요청 전송
  2. 50,000개의 혼합 리소스 ID 요청
  3. 메모리 사용량 및 처리 시간 모니터링
  4. 마스킹 정확도 확인
- **예상 결과**:
  - 모든 리소스가 정확히 마스킹됨
  - 처리 시간 < 5초 유지
  - 메모리 사용량 한계 내 유지
- **엣지 케이스**:
  - 동일한 리소스 ID 반복
  - 유사하지만 다른 패턴들
  - 중첩된 리소스 참조
- **경계 조건**:
  - max_entries (10,000) 도달
  - 10,001번째 엔트리 추가 시도

#### TC-KM-003: Redis 매핑 스토어 불일치
- **테스트 ID**: TC-KM-003
- **테스트 설명**: Redis와 메모리 매핑 간 불일치 상황
- **전제 조건**:
  - Redis에 기존 매핑 데이터 존재
- **테스트 단계**:
  1. 요청 A: EC2 인스턴스 마스킹 (EC2_001 생성)
  2. Redis에서 해당 매핑 수동 삭제
  3. 동일한 EC2 인스턴스로 요청 B 전송
  4. 언마스킹 요청으로 일관성 확인
- **예상 결과**:
  - 새로운 마스킹 ID 생성 (EC2_002)
  - 경고 로그 생성
  - 언마스킹 시 매핑 찾을 수 없음 에러
- **엣지 케이스**:
  - TTL 만료 직전/직후
  - 동시 요청으로 인한 경쟁 상태
- **경계 조건**:
  - TTL 정확히 0초 시점
  - 동시 읽기/쓰기 작업

#### TC-KM-004: 특수 AWS 리소스 패턴
- **테스트 ID**: TC-KM-004
- **테스트 설명**: 엣지 케이스 AWS 리소스 ID 마스킹
- **전제 조건**:
  - 모든 패턴 유형 활성화
- **테스트 단계**:
  1. 최소 길이 EC2 ID: `i-0`
  2. 최대 길이 S3 버킷: 63자 버킷명
  3. 특수 문자 포함: `my-bucket.with.dots`
  4. 대소문자 혼합: `My-BuCkEt-NaMe`
- **예상 결과**:
  - 모든 유효한 패턴은 마스킹됨
  - 유효하지 않은 패턴은 그대로 유지
  - 일관된 마스킹 ID 생성
- **엣지 케이스**:
  - 패턴 경계에 있는 값들
  - 정규식 메타문자 포함
  - 유니코드 문자 포함
- **경계 조건**:
  - 최소/최대 길이
  - 허용 문자 집합 경계

### 3. Redis Connection Loss Handling

#### TC-RD-001: Redis 연결 끊김 (Fail-Secure Mode)
- **테스트 ID**: TC-RD-001
- **테스트 설명**: Redis 연결이 끊어진 상태에서 fail-secure 동작 확인
- **전제 조건**:
  - aws-masker 설정: `redis_fallback: true`
  - Redis 정상 작동 중
- **테스트 단계**:
  1. 정상 요청으로 매핑 생성
  2. Redis 서비스 중지
  3. 새로운 마스킹 요청 전송
  4. 기존 매핑 언마스킹 시도
- **예상 결과**:
  - 새 요청은 503 Service Unavailable
  - "REDIS_UNAVAILABLE" 에러 코드
  - 기존 매핑 접근 불가
  - 보안 우선 정책으로 서비스 차단
- **엣지 케이스**:
  - Redis 재연결 중 요청
  - 부분적 연결 실패 (읽기는 가능, 쓰기 불가)
- **경계 조건**:
  - 연결 타임아웃 직전/직후
  - 재연결 시도 간격

#### TC-RD-002: Redis 메모리 풀
- **테스트 ID**: TC-RD-002
- **테스트 설명**: Redis 메모리 한계(512MB) 도달 시 동작
- **전제 조건**:
  - Redis maxmemory 설정 활성화
  - LRU eviction 정책
- **테스트 단계**:
  1. 대량 매핑 생성으로 메모리 채우기
  2. 메모리 한계 도달 확인
  3. 추가 매핑 생성 시도
  4. 오래된 매핑 접근 시도
- **예상 결과**:
  - LRU 정책에 따라 오래된 매핑 삭제
  - 새 매핑은 정상 생성
  - 삭제된 매핑 접근 시 실패
- **엣지 케이스**:
  - 동시에 여러 키 삭제
  - 큰 값을 가진 단일 키
- **경계 조건**:
  - 정확히 512MB 시점
  - 511MB에서 큰 값 추가

#### TC-RD-003: Redis 클러스터 분할 (Split Brain)
- **테스트 ID**: TC-RD-003
- **테스트 설명**: 네트워크 분할로 인한 Redis 일관성 문제
- **전제 조건**:
  - Redis sentinel 또는 cluster 모드 (있는 경우)
- **테스트 단계**:
  1. 네트워크 분할 시뮬레이션 (iptables)
  2. 양쪽에서 동일 리소스 마스킹
  3. 네트워크 복구
  4. 매핑 일관성 확인
- **예상 결과**:
  - 분할 중 fail-secure 모드 활성화
  - 복구 후 일관성 검증 필요
  - 충돌 매핑에 대한 경고
- **엣지 케이스**:
  - 부분적 네트워크 분할
  - 간헐적 연결 끊김
- **경계 조건**:
  - 분할 감지 타임아웃
  - 복구 감지 시간

#### TC-RD-004: Redis 응답 지연
- **테스트 ID**: TC-RD-004
- **테스트 설명**: Redis 느린 응답으로 인한 타임아웃
- **전제 조건**:
  - Redis 응답 지연 시뮬레이션 도구
- **테스트 단계**:
  1. Redis 명령에 5초 지연 추가
  2. 마스킹 요청 전송
  3. 타임아웃 및 재시도 동작 확인
  4. 지연 제거 후 정상화 확인
- **예상 결과**:
  - Redis 작업 타임아웃 (3초)
  - Fallback 모드 또는 에러 응답
  - 성능 저하 로그 기록
- **엣지 케이스**:
  - 간헐적 지연
  - 특정 명령만 느린 경우
- **경계 조건**:
  - 정확히 3초 타임아웃
  - 2.9초에 응답

### 4. Claude API Timeout/Error Responses

#### TC-CL-001: Claude API 응답 타임아웃
- **테스트 ID**: TC-CL-001
- **테스트 설명**: Claude API가 60초 내 응답하지 않는 경우
- **전제 조건**:
  - 네트워크 지연 시뮬레이션
  - 큰 컨텍스트 요청 준비
- **테스트 단계**:
  1. 최대 토큰 수 요청 전송
  2. 50초 시점에서 연결 상태 확인
  3. 60초 타임아웃 발생 확인
  4. 재시도 로직 동작 확인
- **예상 결과**:
  - 504 Gateway Timeout 응답
  - Kong 재시도 3회 수행
  - 최종 실패 후 에러 응답
- **엣지 케이스**:
  - 59.9초에 응답 시작
  - 부분 응답 후 타임아웃
  - 스트리밍 응답 중 중단
- **경계 조건**:
  - 정확히 60초 시점
  - 재시도 포함 총 시간

#### TC-CL-002: Claude API 429 Rate Limit
- **테스트 ID**: TC-CL-002
- **테스트 설명**: Claude API rate limit 초과 응답 처리
- **전제 조건**:
  - Rate limit에 근접한 요청 수행
- **테스트 단계**:
  1. 연속적인 API 요청 전송
  2. 429 응답 수신 확인
  3. Retry-After 헤더 처리 확인
  4. 백오프 후 재시도 확인
- **예상 결과**:
  - 429 응답 클라이언트 전달
  - Retry-After 헤더 포함
  - Kong rate limiting과 조율
- **엣지 케이스**:
  - Retry-After 없는 429 응답
  - 매우 긴 Retry-After 값
- **경계 조건**:
  - Rate limit 정확한 경계
  - 백오프 시간 계산

#### TC-CL-003: Claude API 5xx 서버 에러
- **테스트 ID**: TC-CL-003
- **테스트 설명**: Claude API 서버 에러 응답 처리
- **전제 조건**:
  - 에러 응답 시뮬레이션
- **테스트 단계**:
  1. 500 Internal Server Error 시뮬레이션
  2. 502 Bad Gateway 시뮬레이션
  3. 503 Service Unavailable 시뮬레이션
  4. 각 에러에 대한 재시도 확인
- **예상 결과**:
  - 5xx 에러는 자동 재시도
  - 3회 재시도 후 최종 실패
  - 적절한 에러 메시지 전달
- **엣지 케이스**:
  - 재시도 중 다른 에러 발생
  - 간헐적 성공/실패
- **경계 조건**:
  - 재시도 간격
  - 최대 재시도 횟수

#### TC-CL-004: Claude API 응답 형식 오류
- **테스트 ID**: TC-CL-004
- **테스트 설명**: Claude API가 예상과 다른 형식으로 응답
- **전제 조건**:
  - 응답 조작 프록시
- **테스트 단계**:
  1. JSON이 아닌 텍스트 응답
  2. 필수 필드 누락된 JSON
  3. 스키마 불일치 응답
  4. 인코딩 오류 응답
- **예상 결과**:
  - 파싱 가능한 부분만 처리
  - 적절한 에러 응답 생성
  - 원본 응답 로깅
- **엣지 케이스**:
  - 부분적으로 유효한 JSON
  - 스트리밍 중 형식 변경
- **경계 조건**:
  - 최대 응답 크기
  - 타임아웃 내 파싱 실패

### 5. Large Request Processing

#### TC-LR-001: 대용량 요청 본문 처리
- **테스트 ID**: TC-LR-001
- **테스트 설명**: 10MB 이상의 요청 본문 처리
- **전제 조건**:
  - 대용량 테스트 데이터 준비
  - 메모리 모니터링 도구
- **테스트 단계**:
  1. 10MB JSON 요청 전송
  2. 50MB JSON 요청 전송
  3. 100MB JSON 요청 전송
  4. 각 단계별 처리 시간 및 메모리 측정
- **예상 결과**:
  - 10MB: 정상 처리 (< 5초)
  - 50MB: 처리 가능하나 경고
  - 100MB: 요청 거부 또는 타임아웃
- **엣지 케이스**:
  - 깊게 중첩된 대용량 JSON
  - 많은 수의 작은 객체
  - 소수의 큰 문자열 값
- **경계 조건**:
  - Nginx 버퍼 크기 한계
  - Kong 메모리 한계
  - 네트워크 대역폭 한계

#### TC-LR-002: 대량 AWS 리소스 마스킹
- **테스트 ID**: TC-LR-002
- **테스트 설명**: 수만 개의 AWS 리소스 ID 동시 마스킹
- **전제 조건**:
  - 다양한 유형의 AWS 리소스 ID 생성기
- **테스트 단계**:
  1. 1,000개 리소스 마스킹 (기준선)
  2. 10,000개 리소스 마스킹
  3. 50,000개 리소스 마스킹
  4. 성능 메트릭 수집
- **예상 결과**:
  - 선형적 성능 저하
  - 메모리 사용량 예측 가능
  - 모든 리소스 정확히 마스킹
- **엣지 케이스**:
  - 중복 리소스 ID
  - 패턴 충돌 가능성
  - 매핑 스토어 포화
- **경계 조건**:
  - max_entries 한계
  - 정규식 엔진 한계
  - Redis 파이프라인 크기

#### TC-LR-003: 스트리밍 응답 처리
- **테스트 ID**: TC-LR-003
- **테스트 설명**: Claude API의 스트리밍 응답 처리
- **전제 조건**:
  - 스트리밍 응답 시뮬레이션
- **테스트 단계**:
  1. 1분간 지속되는 스트림 응답
  2. 중간에 AWS 리소스 포함된 청크
  3. 네트워크 지연 시뮬레이션
  4. 클라이언트 측 수신 확인
- **예상 결과**:
  - 청크 단위로 마스킹 처리
  - 스트림 중단 없이 전달
  - 전체 응답 일관성 유지
- **엣지 케이스**:
  - 청크 경계에 걸친 리소스 ID
  - 불규칙한 청크 크기
  - 스트림 중 에러 발생
- **경계 조건**:
  - 최대 스트림 지속 시간
  - 버퍼 오버플로우 지점

#### TC-LR-004: 동시 대용량 요청 처리
- **테스트 ID**: TC-LR-004
- **테스트 설명**: 여러 대용량 요청 동시 처리
- **전제 조건**:
  - 부하 테스트 도구 (JMeter, K6 등)
  - 리소스 모니터링
- **테스트 단계**:
  1. 10개의 5MB 요청 동시 전송
  2. 50개의 1MB 요청 동시 전송
  3. 100개의 500KB 요청 동시 전송
  4. 시스템 리소스 및 응답 시간 측정
- **예상 결과**:
  - 모든 요청 성공적 처리
  - 응답 시간 < 5초 유지
  - 리소스 사용량 한계 내
- **엣지 케이스**:
  - 일부 요청만 대용량
  - 다양한 처리 시간
  - 연결 풀 고갈
- **경계 조건**:
  - 최대 동시 연결 수
  - 총 메모리 사용량
  - CPU 사용률 100%

## 테스트 실행 가이드

### 환경 준비
```bash
# 테스트 환경 설정
export TEST_ENV=integration
export LOG_LEVEL=debug
export ENABLE_METRICS=true

# 모니터링 도구 실행
docker-compose -f docker-compose.monitoring.yml up -d
```

### 테스트 자동화 스크립트
```bash
# 전체 P0 테스트 스위트 실행
./tests/run-p0-tests.sh

# 특정 카테고리 실행
./tests/run-p0-tests.sh --category nginx
./tests/run-p0-tests.sh --category kong-masker
./tests/run-p0-tests.sh --category redis
./tests/run-p0-tests.sh --category claude-api
./tests/run-p0-tests.sh --category large-request
```

### 결과 분석
- 테스트 결과는 `/tests/test-report/` 디렉토리에 저장
- 각 테스트 케이스별 상세 로그 및 메트릭 포함
- 실패 케이스는 자동으로 재시도 및 상세 분석

## 리스크 완화 전략

### 1. Nginx 장애 대응
- Health check 기반 자동 재시작
- 다중 Nginx 인스턴스 로드 밸런싱
- Circuit breaker 패턴 구현

### 2. Kong Plugin 안정성
- Fail-safe 기본값 설정
- 메모리 사용량 제한
- 패턴 매칭 타임아웃 설정

### 3. Redis 가용성
- Redis Sentinel 구성 고려
- 로컬 캐싱 폴백 옵션
- 주기적 상태 모니터링

### 4. Claude API 복원력
- Exponential backoff 재시도
- 요청 큐잉 및 우선순위
- 대체 엔드포인트 구성

### 5. 성능 최적화
- 요청 크기 제한 적용
- 스트리밍 처리 최적화
- 리소스 사전 할당