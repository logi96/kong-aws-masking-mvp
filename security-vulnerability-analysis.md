# Kong Gateway Runtime 패칭 보안 취약점 심층 분석

## 분석 요약
Kong Gateway AWS Masking MVP 시스템의 Runtime 패칭 메커니즘에 대한 보안 취약점을 분석한 결과, **명시적인 Runtime 패칭이나 HTTPS → HTTP 다운그레이드는 발견되지 않았습니다**. 

그러나 아키텍처 분석 과정에서 여러 보안 우려사항이 확인되었습니다.

## 1. 아키텍처 분석

### 현재 구조
```
Backend API (3000) → Kong Gateway (8000) → Claude API (HTTPS)
    ↓                      ↓                    ↓
Node.js/Express      Lua Plugin           api.anthropic.com
```

### 주요 발견사항
1. **HTTPS 유지**: Backend는 Claude API를 `https://api.anthropic.com`으로 직접 호출
2. **Runtime 패칭 없음**: SSL/TLS 인증서 검증을 우회하는 코드 없음
3. **Kong Transparent Proxy**: Kong이 투명하게 요청을 가로채고 마스킹 처리

## 2. 보안 취약점 분석

### 2.1 API 키 노출 위험 (CVSS: 7.5 - HIGH)

**취약점 설명**
- API 키가 평문으로 전송되는 구간 존재
- Kong 로그에 API 키 일부 노출 (`x-api-key: ***GwAA`)

**CVSS v3.1 평가**
- Base Score: 7.5 (HIGH)
- Vector: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
- Attack Vector: Network
- Attack Complexity: Low
- Privileges Required: None
- User Interaction: None
- Confidentiality Impact: High

**증거**
```javascript
// backend/src/services/claude/claudeService.js:280
headers: {
  'Content-Type': 'application/json',
  'x-api-key': this.apiKey,  // 평문 API 키
  'anthropic-version': '2023-06-01',
}
```

**악용 시나리오**
1. 공격자가 Backend-Kong 간 네트워크 트래픽 스니핑
2. Docker 네트워크 내부에서 패킷 캡처
3. Kong 로그 파일 접근 시 부분적 API 키 획득
4. 브루트포스나 추가 정보 결합으로 전체 키 복원

### 2.2 내부 네트워크 평문 통신 (CVSS: 6.5 - MEDIUM)

**취약점 설명**
- Backend → Kong 구간이 HTTP로 통신
- Docker 네트워크 내부지만 암호화되지 않음

**CVSS v3.1 평가**
- Base Score: 6.5 (MEDIUM)
- Vector: CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
- Attack Vector: Adjacent Network
- Attack Complexity: Low
- Confidentiality Impact: High

**증거**
```javascript
// backend/test-*.js 파일들
const response = await axios.post('http://localhost:8000/analyze-claude', payload, {
```

**악용 시나리오**
1. 컨테이너 탈출 후 Docker 네트워크 접근
2. tcpdump로 내부 트래픽 캡처
3. AWS 리소스 정보 및 API 요청/응답 평문 획득

### 2.3 로깅을 통한 정보 유출 (CVSS: 5.3 - MEDIUM)

**취약점 설명**
- Kong이 헤더 정보를 디버그 로그에 기록
- API 키가 부분적으로 마스킹되지만 패턴 노출

**CVSS v3.1 평가**
- Base Score: 5.3 (MEDIUM)
- Vector: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N
- Confidentiality Impact: Low (부분 정보만 노출)

**증거**
```
kong-gateway | [debug] [aws-masker] [auth_handler] Request Headers: ... x-api-key: ***GwAA ...
```

**악용 시나리오**
1. 로그 파일 접근 권한 획득
2. 여러 로그 엔트리에서 API 키 패턴 분석
3. 타이밍 분석으로 요청-응답 매칭
4. 마스킹된 AWS 리소스 정보 추론

### 2.4 Redis 가용성 의존성 (CVSS: 4.3 - MEDIUM)

**취약점 설명**
- Redis 장애 시 서비스 거부 (Fail-secure 모드)
- 가용성 공격 벡터로 악용 가능

**CVSS v3.1 평가**
- Base Score: 4.3 (MEDIUM)
- Vector: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:L
- Availability Impact: Low

**증거**
```lua
-- kong/plugins/aws-masker/handler.lua:98-104
if self.mapping_store.type ~= "redis" then
  kong.log.err("[AWS-MASKER] SECURITY BLOCK: Redis unavailable - fail-secure mode activated")
  return error_codes.exit_with_error("REDIS_UNAVAILABLE", {
    security_reason = "fail_secure",
    details = "Service blocked to prevent AWS data exposure when Redis is unavailable"
  })
end
```

**악용 시나리오**
1. Redis 서비스 공격으로 가용성 저하
2. 메모리 고갈 공격으로 Redis 장애 유발
3. 정상 서비스 요청 차단으로 비즈니스 영향

### 2.5 Docker 환경의 보안 경계 약화 (CVSS: 3.7 - LOW)

**취약점 설명**
- 컨테이너 간 네트워크 격리가 완전하지 않음
- AWS 자격 증명이 읽기 전용으로 마운트되지만 접근 가능

**CVSS v3.1 평가**
- Base Score: 3.7 (LOW)
- Vector: CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:L/I:N/A:N
- Attack Complexity: High (컨테이너 탈출 필요)

**증거**
```yaml
# docker-compose.yml:98
- ${HOME}/.aws:/home/api-user/.aws:ro
```

## 3. 종합 위험 평가

### 위험 매트릭스
| 취약점 | CVSS Score | 위험도 | 악용 가능성 | 영향도 |
|--------|------------|--------|-------------|---------|
| API 키 노출 | 7.5 | HIGH | 높음 | 매우 높음 |
| 내부 평문 통신 | 6.5 | MEDIUM | 중간 | 높음 |
| 로그 정보 유출 | 5.3 | MEDIUM | 높음 | 중간 |
| Redis 의존성 | 4.3 | MEDIUM | 중간 | 낮음 |
| Docker 경계 | 3.7 | LOW | 낮음 | 중간 |

### 공격 체인 시나리오
1. **초기 침투**: 애플리케이션 취약점을 통한 컨테이너 접근
2. **권한 상승**: Docker 소켓 또는 커널 취약점 악용
3. **네트워크 스니핑**: 내부 트래픽 캡처로 API 키 획득
4. **데이터 탈취**: 획득한 API 키로 Claude API 직접 호출
5. **지속성 확보**: Redis에 악성 매핑 데이터 주입

## 4. 권장 보안 개선사항

### 즉시 조치사항 (Critical)
1. **API 키 보호**
   - 환경 변수 암호화 (AWS KMS, HashiCorp Vault)
   - API 키 로테이션 자동화
   - 헤더에 API 키 직접 노출 대신 서명 기반 인증

2. **내부 통신 암호화**
   - Backend-Kong 간 mTLS 구현
   - 또는 WireGuard 등 VPN 터널링

3. **로깅 보안**
   - 민감 정보 자동 마스킹
   - 로그 수집 시 암호화
   - 접근 제어 강화

### 중기 개선사항 (Important)
1. **네트워크 격리 강화**
   - 네트워크 정책(Network Policy) 구현
   - 최소 권한 원칙 적용
   - 서비스 메시(Istio, Linkerd) 도입 검토

2. **보안 모니터링**
   - 실시간 위협 탐지
   - 이상 행위 분석
   - 보안 이벤트 상관분석

3. **Redis 고가용성**
   - Redis Sentinel 또는 Cluster 구성
   - 자동 페일오버
   - 백업/복구 전략

### 장기 개선사항 (Recommended)
1. **Zero Trust 아키텍처**
   - 모든 통신 상호 인증
   - 세션별 암호화
   - 동적 권한 관리

2. **보안 테스트 자동화**
   - SAST/DAST 통합
   - 침투 테스트 정기 수행
   - 취약점 스캐닝 자동화

## 5. 결론

Runtime 패칭이나 명시적인 HTTPS 다운그레이드는 발견되지 않았으나, 아키텍처 설계상 여러 보안 취약점이 존재합니다. 특히 API 키 노출과 내부 평문 통신은 즉각적인 개선이 필요합니다.

현재 구조는 "Defense in Depth" 원칙에 부합하지 않으며, 단일 보안 계층 침해 시 전체 시스템이 위험에 노출될 수 있습니다. 권장사항에 따른 단계적 보안 강화가 필수적입니다.