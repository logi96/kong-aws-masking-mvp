# Kong AWS Masking ì‹¤íŒ¨ ê·¼ë³¸ ì›ì¸ ë¶„ì„ ë³´ê³ ì„œ

## ğŸ” ê¹Šì´ ìˆëŠ” ë¶„ì„ ê²°ê³¼

### 1. ì½”ë“œ ë³€ê²½ ì´ë ¥ ë¶„ì„

#### Git ì»¤ë°‹ ë¶„ì„
- ì´ 3ê°œ ì»¤ë°‹ë§Œ ì¡´ì¬ (íˆìŠ¤í† ë¦¬ê°€ ì§§ìŒ)
- 4229e72 ì»¤ë°‹: "feat: Complete Kong AWS masking MVP implementation"

#### íŒŒì¼ êµ¬ì¡° ë³€í™”
**ì´ì „ (4229e72 ì»¤ë°‹)**:
- `masker.lua` - ë‹¨ìˆœí•œ Lua íŒ¨í„´ ê¸°ë°˜ ë§ˆìŠ¤í‚¹
- `handler.lua` - masker.lua ì‚¬ìš©
- `text_masker_v2.lua` - ë³µí•© í…ìŠ¤íŠ¸ ì²˜ë¦¬ìš© (ê³„íšë¨)

**í˜„ì¬**:
- `masker_ngx_re.lua` - ngx.re ê¸°ë°˜ ê³ ê¸‰ ë§ˆìŠ¤í‚¹ (ìƒˆë¡œ ì¶”ê°€)
- `handler.lua` - masker_ngx_re.luaë¡œ ë³€ê²½ë¨
- `masker.lua` - ì—¬ì „íˆ ì¡´ì¬í•˜ì§€ë§Œ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ

### 2. í•µì‹¬ ë¬¸ì œì  ë°œê²¬

#### 2.1 ë§ˆìŠ¤í‚¹ ë¡œì§ ë³€ê²½
**ì´ì „ masker.lua** (ì‘ë™í–ˆë˜ ë²„ì „):
```lua
for pattern_name, pattern_def in pairs(patterns.patterns) do
  -- ëª¨ë“  íŒ¨í„´ì„ ì§ì ‘ ìˆœíšŒí•˜ë©° ì²˜ë¦¬
  for match in string.gmatch(text, pattern_def.pattern) do
    -- ë§¤ì¹­ëœ ëª¨ë“  í•­ëª© ë§ˆìŠ¤í‚¹
  end
end
```

**í˜„ì¬ masker_ngx_re.lua** (ë¬¸ì œ ìˆëŠ” ë²„ì „):
```lua
for pattern_name, pattern_info in pairs(pattern_config) do
  -- pattern_configë§Œ ìˆœíšŒ (ì´ˆê¸°í™” ë¬¸ì œ ê°€ëŠ¥ì„±)
  if pattern_info.use_ngx_re and ngx and ngx.re then
    -- ngx.re ì‚¬ìš© (ì¼ë¶€ íŒ¨í„´ë§Œ)
  else
    -- Lua íŒ¨í„´ ì‚¬ìš© (í•˜ì§€ë§Œ ë¡œì§ì´ ë‹¤ë¦„)
  end
end
```

#### 2.2 íŒ¨í„´ í†µí•© ì‹œìŠ¤í…œì˜ ë³µì¡ì„±
1. `patterns.lua` - ê¸°ë³¸ íŒ¨í„´ (í…Œì´ë¸” êµ¬ì¡°)
2. `patterns_extension.lua` - í™•ì¥ íŒ¨í„´ (ë°°ì—´ êµ¬ì¡°)
3. `pattern_integrator.lua` - í†µí•© ë¡œì§
4. `masker_ngx_re.lua` - pattern_config ì‚¬ìš©

ì´ ë³µì¡í•œ êµ¬ì¡°ë¡œ ì¸í•´:
- íŒ¨í„´ì´ ì œëŒ€ë¡œ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ
- ì¼ë¶€ íŒ¨í„´ë§Œ ì‘ë™
- 500 ì—ëŸ¬ ë°œìƒ (undefined ì‘ë‹µ)

#### 2.3 Phaseë³„ ì²˜ë¦¬ì˜ ë¬¸ì œ
masker_ngx_re.luaëŠ” 3ë‹¨ê³„ ì²˜ë¦¬ë¥¼ ì‹œë„:
1. Phase 1: Redis í›„ë³´ ì¶”ì¶œ
2. Phase 2: Redis ë§¤í•‘ ì²˜ë¦¬
3. Phase 3: ì‹¤ì œ ë§ˆìŠ¤í‚¹ ì ìš©

í•˜ì§€ë§Œ Phase 3ì—ì„œ pattern_config ìˆœíšŒ ì‹œ ëª¨ë“  íŒ¨í„´ì´ í¬í•¨ë˜ì§€ ì•ŠìŒ.

### 3. ì™œ ì´ì „ì—ëŠ” ì‘ë™í–ˆëŠ”ê°€?

#### ì™„ë£Œëœ ê³„íš ë¬¸ì„œ ë¶„ì„
`phase3-aws-masking-expansion-plan-completed.md`ì— ë”°ë¥´ë©´:
- text_masker_v2.luaê°€ ê³„íšë˜ì—ˆìŒ
- ë³µí•© í…ìŠ¤íŠ¸ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì„¤ê³„
- í•˜ì§€ë§Œ ì‹¤ì œ êµ¬í˜„ì€ masker_ngx_re.luaë¡œ ë³€ê²½ë¨

#### ê°€ëŠ¥í•œ ì‹œë‚˜ë¦¬ì˜¤
1. ì´ˆê¸°ì—ëŠ” masker.luaë¡œ í…ŒìŠ¤íŠ¸ (ì„±ê³µ)
2. ì„±ëŠ¥ ê°œì„ ì„ ìœ„í•´ masker_ngx_re.lua ë„ì…
3. í•˜ì§€ë§Œ ëª¨ë“  íŒ¨í„´ì´ ì œëŒ€ë¡œ ì´ì „ë˜ì§€ ì•ŠìŒ
4. í…ŒìŠ¤íŠ¸ê°€ ë¶€ë¶„ì ìœ¼ë¡œë§Œ ìˆ˜í–‰ë¨

### 4. í•´ê²° ë°©ì•ˆ

#### Option 1: ì´ì „ ë°©ì‹ìœ¼ë¡œ ë³µì› (ë¹ ë¥¸ í•´ê²°)
```bash
# handler.lua ìˆ˜ì •
local masker = require "kong.plugins.aws-masker.masker"  # masker_ngx_re ëŒ€ì‹ 
```

#### Option 2: masker_ngx_re.lua ìˆ˜ì • (ê¶Œì¥)
```lua
-- mask_data í•¨ìˆ˜ ìˆ˜ì •
-- pattern_config ëŒ€ì‹  ì§ì ‘ íŒ¨í„´ ì‚¬ìš©
for pattern_name, pattern_def in pairs(patterns.patterns) do
  -- ê¸°ì¡´ masker.luaì˜ ë¡œì§ ì ìš©
end
```

#### Option 3: í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼
- ê°„ë‹¨í•œ íŒ¨í„´: Lua string íŒ¨í„´ ì‚¬ìš©
- ë³µì¡í•œ íŒ¨í„´ (ARN ë“±): ngx.re ì‚¬ìš©
- í•˜ì§€ë§Œ ëª¨ë“  íŒ¨í„´ì´ ì²˜ë¦¬ë˜ë„ë¡ ë³´ì¥

### 5. ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì¡°ì¹˜

1. **ë°±ì—… ìƒì„±**
   ```bash
   cp handler.lua handler.lua.backup
   cp masker_ngx_re.lua masker_ngx_re.lua.backup2
   ```

2. **Option 1 í…ŒìŠ¤íŠ¸** (ê°€ì¥ ë¹ ë¦„)
   - handler.luaì—ì„œ masker.lua ì‚¬ìš©ìœ¼ë¡œ ë³€ê²½
   - 50ê°œ íŒ¨í„´ í…ŒìŠ¤íŠ¸ ì¬ì‹¤í–‰

3. **ì„±ê³µ ì‹œ**: 
   - masker_ngx_re.luaì˜ ë¬¸ì œì  ìƒì„¸ ë¶„ì„
   - ë‹¨ê³„ì  ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš ìˆ˜ë¦½

4. **ì‹¤íŒ¨ ì‹œ**:
   - Option 2ë¡œ ì§„í–‰
   - mask_data í•¨ìˆ˜ ì¬êµ¬í˜„

### 6. ê¶Œì¥ì‚¬í•­

**ì¦‰ì‹œ**: Option 1 (ì´ì „ ì‘ë™ ë²„ì „ìœ¼ë¡œ ë³µì›)
- ë¦¬ìŠ¤í¬ ìµœì†Œí™”
- ë¹ ë¥¸ ë¬¸ì œ í•´ê²°
- ë³´ì•ˆ ìš°ì„ 

**ì¥ê¸°ì **: masker_ngx_re.lua ê°œì„ 
- ì„±ëŠ¥ ì´ì  í™œìš©
- í•˜ì§€ë§Œ ëª¨ë“  íŒ¨í„´ ì§€ì› ë³´ì¥

### 7. êµí›ˆ

1. **ë³µì¡ì„±ì˜ í•¨ì •**: ë‹¨ìˆœí•œ í•´ê²°ì±…ì´ ë” ì•ˆì •ì ì¼ ìˆ˜ ìˆìŒ
2. **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€**: ëª¨ë“  íŒ¨í„´ì— ëŒ€í•œ ê°œë³„ í…ŒìŠ¤íŠ¸ í•„ìš”
3. **ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜**: í•œ ë²ˆì— ëª¨ë“  ê²ƒì„ ë°”ê¾¸ì§€ ë§ ê²ƒ
4. **ë¬¸ì„œí™”**: ì™œ ë³€ê²½í–ˆëŠ”ì§€ ê¸°ë¡ í•„ìš”