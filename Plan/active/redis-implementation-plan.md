# Redis 전환 상세 계획

## 목표
현재 완성된 Kong AWS Masker의 메모리 기반 매핑 저장소를 Redis로 전환하여 7일간 데이터 영속성 확보

## 핵심 원칙
1. **무중단 전환**: 기존 통합테스트 100% 통과 유지
2. **Fallback 지원**: Redis 장애 시 메모리 모드로 자동 전환
3. **성능 목표 유지**: 전체 응답시간 5초 이내
4. **보안 유지**: 현재 보안 수준 100% 유지

## 🚨 필수 참조 문서
**구현 시 반드시 다음 설계서를 따라야 합니다:**
- **설계서 위치**: `/Docs/Design/redis-integration-design.md`
- **참조 방법**: 
  - Phase 4 구현 시 설계서의 4장(모듈별 상세 설계)를 **MUST** 준수
  - 모든 코드는 설계서의 인터페이스와 **100% 일치**해야 함
  - 설계서와 다른 구현은 **절대 금지**

## Phase 1: 영향도 분석 (1일) ✅ 완료
### 작업 내용
- [x] 현재 메모리 저장소 사용 코드 전체 분석
  - masker_ngx_re.lua의 mapping_store 구조
  - handler.lua의 저장소 생성/사용 패턴
  - 멀티 워커 환경에서의 데이터 일관성 이슈
- [x] Redis 전환 시 변경 필요 파일 목록 작성
- [x] 테스트 코드 영향도 분석
- [x] 성능 영향 예측 모델 작성

### 산출물 (완료)
- **영향도 분석서**: `/Plan/report/redis-impact-analysis-detailed.md`
- 변경 필요 코드: 약 250줄
- 성능 영향: +3-5ms (허용 범위)

## Phase 2: 상세 설계 (1일) ✅ 완료
### 작업 내용
- [x] Redis 연결 관리 모듈 설계
  - Connection pooling 전략
  - Failover 메커니즘
  - Health check 로직
- [x] 데이터 구조 설계
  - Key naming convention
  - TTL 관리 전략
  - 원자적 연산 보장 방안
- [x] 에러 처리 및 Fallback 설계
- [x] 모니터링 포인트 정의

### 산출물 (완료)
- **상세 설계서**: `/Docs/Design/redis-integration-design.md`
- 모든 인터페이스 정의 완료
- 구현 가능한 수준의 코드 예시 포함

## Phase 3: 테스트 계획 수립 (0.5일)
### 작업 내용
- [ ] 단위 테스트 계획
- [ ] 통합 테스트 시나리오
- [ ] 성능 테스트 계획
- [ ] 장애 시나리오 테스트
- [ ] 기존 테스트 호환성 검증 계획

### 산출물
- 테스트 매트릭스
- 성능 벤치마크 기준
- 장애 시나리오 문서

## Phase 4: 구현 (2일)
### 🚨 필수 준수 사항
**반드시 `/Docs/Design/redis-integration-design.md`의 4장(모듈별 상세 설계)를 따라야 합니다:**
- 4.1절의 masker_ngx_re.lua 수정사항을 **정확히** 구현
- 4.2절의 handler.lua 수정사항을 **그대로** 적용
- 4.3절의 Docker 설정을 **100% 동일**하게 구성

### 📝 설계서 변경 시 절차
**설계서에 오류나 개선점 발견 시:**
1. **즉시 작업 중단**
2. **문제점 상세 분석 및 문서화**
3. **개선 방안 제시**
4. **사용자 승인 후 설계서 업데이트**
5. **승인된 설계서로 구현 재진행**

### 작업 내용
- [ ] Docker Compose에 Redis 추가 (**MUST**: 설계서 4.3.1절 참조)
- [ ] Redis 연결 모듈 구현 (**MUST**: 설계서 4.1.2절 코드 사용)
- [ ] masker_ngx_re.lua 수정 (**MUST**: 설계서 4.1절 전체)
- [ ] handler.lua 수정 (**MUST**: 설계서 4.2절 전체)
- [ ] 설정 파일 업데이트 (**MUST**: 설계서 4.3.2절 redis.conf)
- [ ] 로깅 및 모니터링 코드 추가 (**MUST**: 설계서 6절)

### 산출물
- 구현된 코드 (설계서와 100% 일치)
- 코드 리뷰 체크리스트
- 구현 검증 로그

## Phase 5: 테스트 및 검증 (1.5일)
### 작업 내용
- [ ] 기존 모든 테스트 통과 확인
- [ ] Redis 전용 테스트 실행
- [ ] 성능 테스트 및 비교
- [ ] 장애 복구 테스트
- [ ] 7일 TTL 검증

### 산출물
- 테스트 결과 보고서
- 성능 비교 데이터
- 문제점 및 해결 방안

## 주요 체크포인트
1. **보안**: 매핑 데이터 노출 방지
2. **성능**: 응답시간 5초 이내 유지
3. **안정성**: Redis 장애 시 서비스 지속
4. **호환성**: 기존 테스트 100% 통과
5. **설계 준수**: `/Docs/Design/redis-integration-design.md`와 100% 일치

## 일정
- 총 소요 기간: 5일
- 시작일: 즉시
- 완료 목표: Phase 5 완료 후 프로덕션 준비 상태

## 리스크 관리
1. **Redis 연결 실패**: 메모리 모드 자동 전환
2. **성능 저하**: 캐싱 레이어 추가 검토
3. **데이터 불일치**: 원자적 연산으로 해결
4. **메모리 부족**: Redis maxmemory 정책 설정