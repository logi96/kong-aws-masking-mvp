_format_version: "3.0"
_transform: true

services:
  - name: claude-api-service
    url: https://api.anthropic.com
    protocol: https
    host: api.anthropic.com
    port: 443
    retries: 3
    connect_timeout: 5000
    write_timeout: 60000
    read_timeout: 60000
    tags:
      - claude
      - production

routes:
  - name: claude-proxy-route
    service: claude-api-service
    paths:
      - /v1
    methods:
      - GET
      - POST
      - OPTIONS
    strip_path: false
    preserve_host: false
    regex_priority: 0
    tags:
      - claude
      - proxy

plugins:
  - name: aws-masker
    route: claude-proxy-route
    config:
      # Basic masking features
      mask_ec2_instances: true
      mask_s3_buckets: true
      mask_rds_instances: true
      mask_private_ips: true
      
      # Behavior configuration
      preserve_structure: true
      log_masked_requests: true
      
      # ElastiCache Redis configuration (AWS Production)
      use_redis: true
      redis_type: "managed"
      mapping_ttl: 86400  # 24 hours
      max_entries: 10000
      
      # ElastiCache connection settings
      redis_host: "${ELASTICACHE_HOST}"
      redis_port: "${ELASTICACHE_PORT:-6379}"
      redis_database: 0
      
      # ElastiCache SSL/TLS configuration (Production Security)
      redis_ssl_enabled: true
      redis_ssl_verify: true
      
      # ElastiCache authentication (IAM or AUTH token)
      redis_auth_token: "${ELASTICACHE_AUTH_TOKEN}"
      redis_user: "${ELASTICACHE_USER}"
      
      # ElastiCache cluster mode configuration
      redis_cluster_mode: "${ELASTICACHE_CLUSTER_MODE:-false}"
      redis_cluster_endpoint: "${ELASTICACHE_CLUSTER_ENDPOINT}"
      
      # Additional production settings
      connection_timeout: 5000
      read_timeout: 10000
      keepalive_timeout: 60000
      keepalive_pool_size: 100
    tags:
      - security
      - masking
      - managed
      - elasticache

  - name: correlation-id
    config:
      header_name: X-Correlation-ID
      generator: uuid
      echo_downstream: true
    tags:
      - observability

  - name: request-transformer
    route: claude-proxy-route
    config:
      add:
        headers:
          - "anthropic-version:2023-06-01"
          - "x-api-key:${ANTHROPIC_API_KEY}"
      remove:
        headers:
          - "X-Real-IP"
          - "X-Forwarded-For"
    tags:
      - security

  - name: response-transformer
    route: claude-proxy-route
    config:
      add:
        headers:
          - "X-Kong-Proxy:true"
          - "X-Masked-Response:true"
          - "X-Redis-Mode:managed"
          - "X-ElastiCache-Enabled:true"
    tags:
      - metadata

  # Production-specific plugins
  - name: rate-limiting
    route: claude-proxy-route
    config:
      minute: 1000
      hour: 10000
      policy: redis
      redis_host: "${ELASTICACHE_HOST}"
      redis_port: "${ELASTICACHE_PORT:-6379}"
      redis_password: "${ELASTICACHE_AUTH_TOKEN}"
      redis_ssl: true
      redis_ssl_verify: true
    tags:
      - rate-limiting
      - production

upstreams:
  - name: claude-api-upstream
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        healthy:
          interval: 30
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 5
          tcp_failures: 5
          timeouts: 5
      passive:
        healthy:
          successes: 2
        unhealthy:
          http_failures: 5
          tcp_failures: 5
          timeouts: 5
    tags:
      - claude
      - managed
      - production