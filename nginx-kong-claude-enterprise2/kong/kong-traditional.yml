_format_version: "3.0"
_transform: true

services:
  - name: claude-api-service
    url: https://api.anthropic.com
    protocol: https
    host: api.anthropic.com
    port: 443
    retries: 3
    connect_timeout: 5000
    write_timeout: 60000
    read_timeout: 60000
    tags:
      - claude
      - production

routes:
  - name: claude-proxy-route
    service: claude-api-service
    paths:
      - /v1
    methods:
      - GET
      - POST
      - OPTIONS
    strip_path: false
    preserve_host: false
    regex_priority: 0
    tags:
      - claude
      - proxy

plugins:
  - name: aws-masker
    route: claude-proxy-route
    config:
      # Basic masking features
      mask_ec2_instances: true
      mask_s3_buckets: true
      mask_rds_instances: true
      mask_private_ips: true
      
      # Behavior configuration
      preserve_structure: true
      log_masked_requests: true
      
      # API Authentication Configuration
      anthropic_api_key: "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"
      
      # Traditional Redis configuration (Local/Development)
      use_redis: true
      redis_type: "traditional"
      mapping_ttl: 86400  # 24 hours
      max_entries: 10000
      
      # Traditional Redis connection settings
      redis_host: "redis"
      redis_port: 6379
      redis_database: 0
      redis_password: "${REDIS_PASSWORD}"
      
      # ElastiCache fields explicitly disabled for traditional mode
      redis_ssl_enabled: false
      redis_ssl_verify: false
      redis_auth_token: null
      redis_user: null
      redis_cluster_mode: false
      redis_cluster_endpoint: null
    tags:
      - security
      - masking
      - traditional

  - name: correlation-id
    config:
      header_name: X-Correlation-ID
      generator: uuid
      echo_downstream: true
    tags:
      - observability

  - name: request-transformer
    route: claude-proxy-route
    config:
      add:
        headers:
          - "anthropic-version:2023-06-01"
          - "x-api-key:${ANTHROPIC_API_KEY}"
      remove:
        headers:
          - "X-Real-IP"
          - "X-Forwarded-For"
    tags:
      - security

  - name: response-transformer
    route: claude-proxy-route
    config:
      add:
        headers:
          - "X-Kong-Proxy:true"
          - "X-Masked-Response:true"
          - "X-Redis-Mode:traditional"
    tags:
      - metadata

upstreams:
  - name: claude-api-upstream
    algorithm: round-robin
    slots: 10000
    healthchecks:
      active:
        healthy:
          interval: 30
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 5
          tcp_failures: 5
          timeouts: 5
      passive:
        healthy:
          successes: 2
        unhealthy:
          http_failures: 5
          tcp_failures: 5
          timeouts: 5
    tags:
      - claude
      - traditional